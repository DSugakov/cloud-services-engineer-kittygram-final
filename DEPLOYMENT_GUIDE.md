# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã Kittygram

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Kittygram —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Terraform –∏ GitHub Actions.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã:
1. **VPC Network** - –æ–±–ª–∞—á–Ω–∞—è —Å–µ—Ç—å –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
2. **VPC Subnet** - –ø–æ–¥—Å–µ—Ç—å —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º 192.168.10.0/24
3. **Security Group** - –≥—Ä—É–ø–ø–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:
   - SSH –¥–æ—Å—Ç—É–ø (–ø–æ—Ä—Ç 22)
   - HTTP –¥–æ—Å—Ç—É–ø –∫ gateway (–ø–æ—Ä—Ç 9000)
   - HTTP –¥–æ—Å—Ç—É–ø (–ø–æ—Ä—Ç 80)
   - HTTPS –¥–æ—Å—Ç—É–ø (–ø–æ—Ä—Ç 443)
   - –í–µ—Å—å –∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω
4. **Compute Instance** - –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Ubuntu 24.04 LTS
5. **S3 Bucket** - –±–∞–∫–µ—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Terraform state

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ—Ä—ã–≤–∞–µ–º–∞—è –í–ú –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose —á–µ—Ä–µ–∑ cloud-init
- State —Ñ–∞–π–ª —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ S3 —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ cloud-init —Å–∫—Ä–∏–ø—Ç

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Yandex Cloud

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
yc iam service-account create --name terraform-sa

# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
yc resource-manager folder add-access-binding <folder-id> \
  --role editor \
  --subject serviceAccount:<service-account-id>

yc resource-manager folder add-access-binding <folder-id> \
  --role storage.admin \
  --subject serviceAccount:<service-account-id>

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞
yc iam key create --service-account-name terraform-sa -o key.json
```

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è Object Storage:
```bash
yc iam access-key create --service-account-name terraform-sa
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ ID –æ–±–ª–∞–∫–∞ –∏ –ø–∞–ø–∫–∏:
```bash
yc config list
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –≤–∞—à GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

1. **YC_CLOUD_ID** - ID –≤–∞—à–µ–≥–æ –æ–±–ª–∞–∫–∞
2. **YC_FOLDER_ID** - ID –ø–∞–ø–∫–∏ –≤ –æ–±–ª–∞–∫–µ  
3. **YC_SERVICE_ACCOUNT_KEY_FILE** - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ JSON –∫–ª—é—á–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
4. **YC_STORAGE_ACCESS_KEY** - Access Key –¥–ª—è S3
5. **YC_STORAGE_SECRET_KEY** - Secret Key –¥–ª—è S3
6. **SSH_PUBLIC_KEY** - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ SSH –∫–ª—é—á–∞

### 3. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª Actions –≤ GitHub
2. –í—ã–±–µ—Ä–∏—Ç–µ workflow "Terraform Infrastructure"
3. –ù–∞–∂–º–∏—Ç–µ "Run workflow"
4. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
   - **plan** - –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - **apply** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - **destroy** - —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## üìã –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (Plan)
```bash
# –í GitHub Actions –≤—ã–±–µ—Ä–∏—Ç–µ "plan"
# –≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Apply)
```bash
# –í GitHub Actions –≤—ã–±–µ—Ä–∏—Ç–µ "apply"
# –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –≤—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π workflow –¥–ª—è –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –í–ú

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Terraform —Ñ–∞–π–ª—ã:
- `infra/main.tf` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- `infra/variables.tf` - –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `infra/outputs.tf` - –≤—ã—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- `infra/providers.tf` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ backend
- `infra/cloud-init.yml` - —Å–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –í–ú

### Backend –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
```hcl
backend "s3" {
  endpoints = {
    s3 = "https://storage.yandexcloud.net"
  }
  bucket = "kittygram-terraform-state-158160191213"
  region = "ru-central1"
  key    = "tf-state.tfstate"

  skip_region_validation      = true
  skip_credentials_validation = true
  skip_requesting_account_id  = true
  skip_s3_checksum            = true
}
```

## üê≥ Cloud-init –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é cloud-init:

- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu —Å sudo –ø—Ä–∞–≤–∞–º–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞
- –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä outputs:
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã:
- `vm_external_ip` - –≤–Ω–µ—à–Ω–∏–π IP –∞–¥—Ä–µ—Å –í–ú
- `kittygram_url` - URL –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- `s3_bucket_name` - –∏–º—è S3 –±–∞–∫–µ—Ç–∞

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Terraform:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
terraform show

# –ü—Ä–æ—Å–º–æ—Ç—Ä outputs
terraform output

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
terraform plan
terraform apply
```

## üßπ –û—á–∏—Å—Ç–∫–∞

### –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
1. –í GitHub Actions –≤—ã–±–µ—Ä–∏—Ç–µ "destroy"
2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ
3. –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã

### –†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ:
```bash
cd infra
terraform destroy
```

## üîç –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û—à–∏–±–∫–∞ "Variables not allowed" –≤ backend**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `providers.tf` –Ω–µ—Ç `var.*` –≤ –±–ª–æ–∫–µ backend
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ `-backend-config`

2. **–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ GitHub
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–æ–ª–∏

3. **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è S3 –±–∞–∫–µ—Ç–∞**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ Object Storage
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º—è –±–∞–∫–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ

### –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terraform plan` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ Yandex Cloud Console

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Terraform –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://www.terraform.io/docs)
- [Yandex Cloud Terraform –ø—Ä–æ–≤–∞–π–¥–µ—Ä](https://cloud.yandex.ru/docs/tutorials/infrastructure-management/terraform-quickstart)
- [Cloud-init –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://cloudinit.readthedocs.io/)

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ GitHub Actions
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Yandex Cloud
